{% extends 'base.html' %}
{% load static %}

{% block title %}Mis Pedidos - Superventas{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-success">
                <i class="bi bi-box-seam"></i> Mis Pedidos
            </h1>
            <p class="text-muted">Aquí puedes ver todos tus pedidos realizados</p>
        </div>
    </div>

    {% if pedidos %}
        <div class="row g-4">
            {% for pedido in pedidos %}
            <div class="col-12">
                <div class="card shadow-sm hover-shadow">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h5 class="mb-1">
                                    <i class="bi bi-receipt"></i> {{ pedido.numero_pedido }}
                                </h5>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> {{ pedido.fecha_pedido|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                            
                            <div class="col-md-2">
                                {% if pedido.estado == 'pendiente' %}
                                    <span class="badge bg-warning text-dark fs-6">
                                        <i class="bi bi-clock-history"></i> Pendiente
                                    </span>
                                {% elif pedido.estado == 'procesando' %}
                                    <span class="badge bg-info fs-6">
                                        <i class="bi bi-arrow-repeat"></i> Procesando
                                    </span>
                                {% elif pedido.estado == 'enviado' %}
                                    <span class="badge bg-primary fs-6">
                                        <i class="bi bi-truck"></i> Enviado
                                    </span>
                                {% elif pedido.estado == 'entregado' %}
                                    <span class="badge bg-success fs-6">
                                        <i class="bi bi-check-circle"></i> Entregado
                                    </span>
                                {% elif pedido.estado == 'cancelado' %}
                                    <span class="badge bg-danger fs-6">
                                        <i class="bi bi-x-circle"></i> Cancelado
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-2">
                                <p class="mb-0 text-muted">
                                    <small><i class="bi bi-box"></i> Items:</small>
                                </p>
                                <h6 class="mb-0">{{ pedido.total_items }}</h6>
                            </div>
                            
                            <div class="col-md-2">
                                <p class="mb-0 text-muted">
                                    <small>Total:</small>
                                </p>
                                <h5 class="mb-0 text-success fw-bold">
                                    S/. {{ pedido.total }}
                                </h5>
                            </div>
                            
                            <div class="col-md-3 text-end">
                                <a href="{% url 'ventas:detalle_pedido' pedido.id %}" class="btn btn-success btn-sm w-100 mb-2">
                                    <i class="bi bi-eye"></i> Ver Detalle
                                </a>
                                {% if pedido.estado == 'pendiente' or pedido.estado == 'procesando' %}
                                <button class="btn btn-danger btn-sm w-100" onclick="cancelarPedido('{{ pedido.id }}', '{{ pedido.numero_pedido }}')">
                                    <i class="bi bi-x-circle"></i> Cancelar Pedido
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Total de pedidos:</strong> {{ total_pedidos }}
                </div>
            </div>
        </div>
    {% else %}
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-box-seam text-muted" style="font-size: 5rem;"></i>
                    <h3 class="mt-3 text-muted">No tienes pedidos aún</h3>
                    <p class="text-muted">Explora nuestro catálogo y realiza tu primera compra</p>
                    <a href="{% url 'ventas:index' %}" class="btn btn-success mt-3">
                        <i class="bi bi-shop"></i> Ir al Catálogo
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.hover-shadow {
    transition: all 0.3s ease;
}

.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
}
</style>

<script>
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function cancelarPedido(pedidoId, numeroPedido) {
    if (!confirm('¿Estás seguro de que deseas cancelar el pedido ' + numeroPedido + '?\n\nEsta acción no se puede deshacer.')) {
        return;
    }
    
    var csrftoken = getCookie('csrftoken');
    
    fetch('/cancelar-pedido/' + pedidoId + '/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.status === 'success') {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ ' + data.message);
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        alert('❌ Error al cancelar el pedido. Por favor, intenta de nuevo.');
    });
}
</script>
{% endblock %}
